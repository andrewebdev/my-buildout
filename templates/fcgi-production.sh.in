#!/bin/sh
 
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DESC="FastCGI "
NAME=${control-script}
 
ROOT=${buildout:directory}
BIN_PATH=$ROOT/bin
LOG_PATH=$ROOT/log
CONTROLSCRIPT=$BIN_PATH/$NAME
SOCKETFILE=$BIN_PATH/$NAME.sock
PIDFILE=$BIN_PATH/$NAME.pid
 
d_start(){
    $CONTROLSCRIPT runfcgi \
        maxchildren=1 \
        maxspare=1 \
        method=prefork \
        pidfile=$PIDFILE \
        socket=$SOCKETFILE \
        > /dev/null 2>&1 &
}

d_stop(){
    if [ -f $PIDFILE ]; then
       kill `cat $PIDFILE`
       rm -f -- $PIDFILE
    fi
}

check_running(){
	# Check that the process is running. If not, restart
	if [ -f $PIDFILE ]; then
		# We have a PIDFILE. Check if the process is running
		if [ `ps -u ${username} | grep -i ${control-script} | wc -l` -lt 1 ]; then
			d_start
		fi
	else
		d_start
	fi
}
 
 
case $1 in
    start)
		echo -n "Starting $DESC: $NAME"
		d_start
		echo "."
		;;
	stop)
		echo -n "Stopping $DESC: $NAME"
		d_stop
		echo "."
		;;
    restart)
		echo -n "Restarting: $DESC: $NAME"
		d_stop
		sleep 1
		d_start
		echo "."
		;;
	check)
		echo -n "Checking if the $DESC: $NAME is running..."
		check_running
		echo "."
		;;
    *)
    echo "Usage: $0 (start|stop|restart|check)"
    exit 1
    ;;
esac
